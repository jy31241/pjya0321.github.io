---
layout: post
cover: 'assets/images/cover6.jpg'
title:  CodeEngn Advance 1
date:   2017-04-30 12:09:25
tags: fiction
subclass: 'post tag-fiction'
categories: 'pjya0321'
navigation: True
logo: 'assets/images/ghost.png'
---


## 1번 문제풀이
-----
문제 : 이 프로그램은 몇 밀리세컨드 후에 종료 되는가 정답인증은 MD5해쉬값(대문자)변환 후 인증하시오

실행해보니 처음에 PUSHAD가 보여서 PEiD로 확인해보니 UPX로 패킹 되 있는 프로그램이라서, 먼저 UPX툴로 언패킹을 하고 시작했다.

![1](https://lh3.googleusercontent.com/Ho3MKvZzl0CTj9dzbevixsDkVSKQpNni5U19LpkeeQvCRxQD1BP2qNtGtkI4eoMFHb2GJiNkWjxBclU2zY9O7X9QYK4tlsA0Lgn8_K4AmaySZckPCMbw-p4OAY-4smnaBVql2pBtYAdW6Nc0Gyq4khmOWzBtAIpvH-QMmVl9LMdR4gCO66gIJy4evo6YgW6MmZbcFLYyWTCHkVYmtjyvW_aykXF09WabBjqot-ftKOVQzp5CzvVa0rlv3QUJNbg16IVi1gSt6tLs0pJKXuWUeb6K3aHk-pLTzIwEfFDop_v7L4In1-SjRQMvJ6e8gLEC0C6Io7Pw0RLZAXeWKKWgFpRxDM3laSy5NxCkU-H8ONblTl2Rkl27cTIRcEWxrj2y0IsAUnOVXL4c9KYGYI3yh_DeeTJG1HtQfSYPUwGiioap9t4K_9nj6on8EX6zJ2X9AEJnzbL_T6nZhtpIIgYlzgsCjeRJVHRmed3YRGDGg3XjDAR6zR1Zn5JFFiOi6dChNIIcj9qsiHJqnnn34G3skNHn0Cd2kZ-DR-w1AXg6eYKISYSh9hQWXn6Jib7J3cr8bB88XMqX5w7FsRzAQHijXJcW18fWu0dNeaFucW_WrynO5WL63kw=w669-h438-no)

실행 시간 값 구하는 문제라서 sleep과 timegettime 함수들에 브레이크포인트를 걸어주고, 실행했더니, 비정상적으로 리턴하고 다시 진행되다가 그림 2같은 에러창이 떴다.

![2](https://lh3.googleusercontent.com/Epop66OVaVaFYRZd-rbH0lKDj0ZU2tB-oVv99z1oi-4FpFY4PPIO_QHgSawXBD5gWACMDPMY093B6cK3LZTe7w_N-ChRQ17Hj5mcuEepyu4Vaxfp7MlusMPA5v75Mwo1F2vQHjKeyqE-quP20NW5-unI_pBRMeDrge87l0WKZ-Ostji0Tx4vEsI3stk1Bd5NeD6RRSsWNxe-27Xd0IBBmNfJGX5jOsNWxktRu9WnBmWZ6CMDT1zL0Hk4yocZJuob2hor5E2iWi1D5IB4ZdRZnnNYhfIulRk5rlnCTrmpKJf_uWhVOWN3HCWE-BV0MwzacEN48DvqAjLBVhdm1yKSFhHc-Gg-aOMdtwvuuGAwB0WT_cpLrkkaet81lgy2t4pncVdJ_jD753pgABUN-gAhPbQO_ZgdTiWwsu8re65gll1BrYZajU2zNtu_3NvWCQO9EfvzvoaPme-pfB6--JRnvbRuSt3i_QvcLlPlr6rpiZ3eDs6SmyHM2xWcBwSOb3Cfn7r1UX5OkJp4bNLys6qZeZ_5y5NJt20N4qfYGZxwhc8Xl1KrlbcujeHXJuRdQ0qjvllm6AyIJWa1ubjGc_OYuMSIRdIYJK9JY-MthJr_1B87B5U=w612-h121-no)

함수목록에서 안티 디버깅 함수중 IsDebuggerPresent를 찾아서 TEST EAX,EAX를 CMP EAX,EAX 로 수정했다. 그럼 Z플래그가 1로세팅되서 0040E969에서 에러 메시지 출력하는 분기점으로 넘어가지 않는다.

![3](https://lh3.googleusercontent.com/thG3nYWYbHndbIEA-dlbu5-2LRnFGqkPO2GLF6hYl0kBOapk4o4CaX-JPu7hiU6ZotsV930d-bbD2Ep43xM1Rbn0PzEscfj8fXnoglKRzzowye1Zpj9c5hUAgI4H2YmObv1_8p-1VwZdiamFcXPa23k89JtUZYs_l23S8t5fyj1x5LzGgLUCH6zezmiWQuP7FdLgy0GMnU9s0XSKZauZws5ES_SIq6Y6iA9Vf95fmXt89727QOvUG2o2GCInrqzGr3jMxF5DFEduk7lNBAnwTR1p_zp5LsgjO7-uEc7_Jc_NX9ewHsPW1PlVPpqqeclshWtA0VcRZlucnjhWuUcEyApClRSW3J138UOmpB2i7WB4hc7vlV00CZK7y5cSzpiXgjwo0pA1Qx2PFRpmZoCPZfBr_LfvL7hNPptCBZLWRkkd5Y85KL9JYutqwEjpvzDjVOUT9O-oUOMMrVsjujCx5Ii_HaPvw_4FXGmjFQ1H93Xk4Wc_w5wUD4nB6vLK8MrvvB7tHo18saoBgWqR0yNVQMkW8tbqadNOBKfkzTtFabIj8xa42O6A8kmt43WuApn59MSSodybcaAzQl8iMdOLBkENPh2A6ULG6OcJEKrLWMvhnKA=w733-h116-no)

안티디버깅 해제후 진행을 하니 계속 프로그램이 무한루프에 빠진건지 멈춰버리는 일이 발생했다.
해당 함수를 브레이크포인트 걸고 함수내부를 확인하다 또다시 멈추고 이런 반복을통해
0040eaf9, 0040ea13, 0040b218, 0040bcc0, 00444d3a, 0045E05F, 00444db8, 77D46574  총 7번을 들어가보니 WaitForSingleObject 라는 함수를 발견했다. 그전까지는 메시지박스 관련된 함수들만 나왔는데 처음보는 함수라서 구글에 검색해보니 Thread가 특정 signal이 발생할 떄 까지 정지해 있다가, signal (Exit_event) 을 받으면, 작업을 수행할 때 사용하기 위한 api라고한다.
문제랑은 큰 관련이 없다.

WaitForSingleObject function
-Waits until the specified object is in the signaled state or the time-out interval elapses.
(출처 MSDN)


timeGetTime함수전체에 브레이크 포인트를 걸고 F9로 실행해버리면 계속 무한루프에 빠저서 천천히 관련 없는 함수를 넘기고 직접 timeGetTime함수가 있는 곳까지 하나하나 진행했다. Basic19에서 밀리세컨즈 구하는 문제랑 비슷하게 timeGetTime함수가 실행된후 ESI값과 EAX값을 비교하고 같지 않으면 EAX에 ESI를 빼고 그 값을 EBX+4 스택에 저장된 값과 비교를한다. Basic에서 푼 문제와 거의 완전히 유사한데 중간중간 프로그램이 멈춰버리는 부분들이 많다.

![4](https://lh3.googleusercontent.com/4N_hOzISkTL64IA-D8BfJ6_oma1Vk_7rcdoNd66QvYjkdnOp-JK-rilLNHQUEEAgoBro-SLFj0q5ONpYmNsRvrf1gEaeqBAd2VroVDl1pQC32j3lp8Nwh4bxMQBAzGGzTgtww2JCuLCN_3vF4exc7b2fJcBCvbuTV04nqVRS-wHu-JqxxOQpRurhI8rTRhjZ6h3aznuyeyui1Y8V4YyeuVRVTiVNF-NI5sqizDMWFXm0p66pbIFA4ep6ycd2ejr1xfzaQFj20V1RBBYmhg1_YI6JB7o-SgtLktEHK7jDsCmgzYp1J2arvhuGNzCWKJNVWke8T_F3gBSYG9Rr2Zic3ojNvm0ieD8pzdjRzxNJlq0snp8obDisqwaEfwcX_YfgQ9NPwb8oTjVa6uAVNtV9BUDR7AulkNeWkUs_IN9XwBMoCDTYjEhQkWsjVtV_-CRLD98acD2BLbyfPMF9ZbGMvw8-_KpcqKjbOBf5kx_-i25Uetad6yxunZSPOnpwCif-PJD2CWkxnj6w4RX9MYjTqu2Z8qCSvTRdXL1xQtcSERy8V-FmAOMohddSe5XhjpR59dl9DgG_7F767nbLienkIoYLmMNat63OkzZ3JdMfc27oj8M=w733-h128-no)

00444c44에서 리턴된 EAX를 ESI에 넣고 00444c59에서sleep후 00444c5f에서 timeGetTime를 실행해서 리턴된 값을 ESI(위에서 리턴된 timeGetTime 값)와 비교해서 00444D38로 점프한다.

![5](https://lh3.googleusercontent.com/wy-Jj2YMK_VomgU1EEyaGU5IEJk3Ulzn98WHVQiXKeoOEqxYF_TPsx_ugJ3_uabTShVqmaMZNPGdQmGSFry_Dyv2T9ZTlvN5kN0tJT1_792FUADpnKS9iKiLsc2YgG7bZJQMjUdH6XVGp_UWSF_bR2s8Stn9Wl8sioC_fLP5w9LEyWSudGK9-JrxwEImFkHqjXUTk8IFZHbIVg-DE7qFsFAGRAhphO2jJ7go9ttpUqThsbi3k5gqn8ukn-JadFcllD34vilMIaam7JEIT3UFZk5FIkRspUzKDMt6_lYTuis6uSBS4f2VPn5ktoJ_5KQK3BLY4V03Sx0vdyRAdMw_9bdUo4zdZK2xu-YoVdNri9wID8wBiOReraF3yrZ_Jh3fqKr9Ewoz1YS0RXiLJCekdh10KOOjoSUOR5Sj3rEhZMQyhTlxVHCniuqRwUCMsn0nyt4EKPIU2y0b6xjUBPNYR8dndLE81_nb0Z4J-lyiD1MlPH63EFKHDiTMByoBZhxT3vr34qjsivO9Uw7p43resPI-hMVjO2gxrLRJfZgb_F67oWN7ZfUw5X4dIOvciXbsUt9EAdwsvpU2U2sy8grOC_21j-kiJ4hc59FCisJnfFO6mZc=w549-h46-no)

점프해보면 00444D38에서 기록된 시간값(timeGetTime함수 리턴값) 둘을 빼서 걸린 시간을 연산하고 그후에 EBX+4 스택에 있는 값과 비교를 한다.

00444C44에서 루틴에 들어온 시간을 리턴하고, 00444C59에서 Sleep실행 후 다시 00444C5F를 실행할 때 까지의 시간을 리턴 한 뒤 서로 빼서 걸린 시간을 계산하는 문제다.

![6](https://lh3.googleusercontent.com/T4HaqH4NjCE8hVN7KzG4QgBn2a0dD4PDyxc5cHLz8eH9rkoDRp-yRAke3z4H0vK8s4Vvokv5_xj7Zl_w6Quq6F6CVfIZYCJluSgeGUqziUFGGVPFGalEd2_lotVzk1DU5YH8WN7QhQcuJ4FM4-mPTtwFHKXwl5KvVcAO3jWUqdpEoWDQ4zBpRkiT944uOvtKUXzwBiO6N48wjh53Uc1F4JS1p9GMRu2wKBN5njijZEtKXqSFwVQ7FGUO5G3IyTntf5GW1c8UeioS9FASUWwV_o-OEJMgqXObvk2USaC6ObTg4ZFJq2Ug-pGWs4Ein9TbDIofSumo7Qcyzlqq-j88qPp2jDZY9NKc07XwYsEANhVdOTHhTQCl1qs6i02SiwJbzzmBWFlDbcqGZ_FIersvtU0gRryyG1JATi0s0J1WBVPHVoOIbM6XBcqM3SOOyPxSvxGhc4c4B46zoU3muBgHmH_dS8xWmsUsHJBz2qIifU8j2lTH_wwIkoAXKyGWn6zB8--mgLvZH17n_SLHVLlPkL9ny50Cit7NEVikYoE59sJL9GK0399ft6PzVSmwCIGcDRqpySjcPyeUmJSBw0iGHNAvqo0AE5xXYKSWwTelMu-Gn5Q=w295-h48-no)

따라서 EBX+4에 저장된 값 337B 십진수로 바꾸면 “13179” MD5 해쉬값 으로 암호화하면 정답은 “DB59260CCE0B871C7B2BB780EEE305DB” 다
