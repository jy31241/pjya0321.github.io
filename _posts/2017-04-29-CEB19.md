---
layout: post
cover: 'assets/images/cover6.jpg'
title:  CodeEngn Basic 19
date:   2017-04-30 12:09:14
tags: fiction
subclass: 'post tag-fiction'
categories: 'pjya0321'
navigation: True
logo: 'assets/images/ghost.png'
---



## 19번 문제풀이
-----
문제 : 이 프로그램은 몇 밀리세컨드 후에 종료 되는가

디버거로 실행시키면 PUSHAD가 보인다. 패킹 된 프로그램 같다. PEiD로 확인해본 결과 그림 21에서 보이듯이 UPX로 패킹 되어 있다.

![19-1](https://lh3.googleusercontent.com/T5ehmbNfgtJfeeWdg0F01UYCWA2Z4Jloc-1bNKMTWliyTvScGIlTq3AbhGMEXJlDW-dAu7Ox4eM0LqKaFkbowEljqy3OvI6Mn0Jyknlf4GkW__nnwO-1WkOQ4BNfHTrdacxjAMChXvnQph8vvDJ0d3GbjR7p5iGXAplwIZmUhbzIooe_KYl9NE2sneccph0UFEV3Po4YzMvOB8b-B7NFOztZKUAKjtotauG4zof290x9VhjxcS4OgEB-pP_GRxqBPbXcOwWapAyEnH1pz9Gt7NufLm2l-qH8qeXqgWrzTIOxYd1EDZNQdPWI8DJf86k1l4EkdSJl8Ud6_LgH-KV0ILV61hh2XXfH8IqXh8e0FKkwvOkHqYERhbdg8ikO5JYKBNzJxNF-PVyQiwbOghEz2uVMuzpgWs8dLdZBuvbE0zX-VBNbIhTKals_D09vIa8yIRoFjrvlrN2GsrnPEhMHIPC130193fbnYFCRbB_sePnVpItakJpLAXhsDs91h-I-1yLGnf08lqjLXs3OzShfLXWzLIiFSJqwWmfz308XB5noVMNA52T3HfvfvSm9WycJZsQL77hQbCFi7HZ3WC99r2N3GnARHMWTcE4c47-3gPmUTVY4ulA=w637-h185-no)

![19-2](https://lh3.googleusercontent.com/xM6rjwfiHIYq2qz1gVtlhSBbCfJ2QZaXtOlcwjD7IctLfzSxrZojFQ0qRVRT9QR9fq_Lbr3Q0pcQUCHt4JC1kT2IKAKTRZ8escvmXHV9yrqOt2mbzborp07JAYy4MJciGw40Vp0SF0wlWYoi-OWBneVUYQIH5P0W5z4Yzc0k_S9zJv6HAoYwvMtmOfnnqOW38IdoH4BXVfsWCxP4wAdzUQkQc0y6jxanKHLxCV5OgMmRQKu_-mf63aVuXSOpIlVj1mkLITfUxYBdKWhTpMyRfmKrmfcEfXA_SLaSPS11VVQIsF3D8Cub_iUdq8Y_QVbU7TOaDLt7mpy_02h3sUVeXPGCBCKz36uR0CvJSIBSTNOIe1dPxEIarth8vV0CrwGC5E7rS4vgmpgvmpkXkFUyBnhddFS9tvkouP99pgelYNhpo_Yg5FUkOCnb2t8iFz0dbRY8b9XQzsRn7FuDCBZ5hTJGC4xIji8fcZJFerpVp27oLhvKYN6kOyUrxVhBZfBNhbt5vFTkhnnTcDti15-KZ37rm-MKxMW0IQmfmcjUXwoZQi9p90mqfGeezIdFRBvBDbR2LPkVmew-V5bSlDllDqQkBdDjif0uCDcFrs43HfL0GxY=w422-h243-no)

직접 OEP를 찾아서 dump해도 되지만, 덤프따기 귀찮기 때문에 UPX를 이용해서 언패킹을 실행했다.

![19-3](https://lh3.googleusercontent.com/OknOWYOvA_Nq8DZ0bb4WRWCV2qc1aeMNeUlJbHG3fFNnsi96po3j0eMNvMZaURsv16zR_M1i1qhzjM7Q3Id71iveLGad-U5W_mQz3GtsMa-Y9LengG13TnCBdoK7GBWr3gFizxuwAtTaZ5Y_DhvctkDE2fM5_t-kGxJ5k8DUBmE8H5-b9mm3ivtNotlH-cyJeKQhdKvBhGTLd6jMsQ4hxjudFQoG5d2ZGkxfw3OdlA2nL17eGkIwjq2DWmXAe7a69J5IWrjGQglpVBAWG2cn3GvVw6EeJacM4on8Ki-DygUwsbL-Am6TBcoxmC8dJcs49K8dXbQJYc-YRE_dWI1pOyiEcDgEpSyoIm1-WhekRsZRmxBSca4KYfHwHtmPDMF0aBMkBD6xt2nwzUOg_O3tGwbzYhY-Cqtb_9d0w4AR2kKuTAdYF15XNajSJM4ZoD3LHL_96ADcmYBqOa4lTdqf8S4fqQXJKd3Qnp9nyFpsXxf3v7XCUS79G_IFN2gKf9wmcZ6OOnVOzrOP59P3i_jcQdZ2VNrCtthXlsbKIFWsUc2hxKuoblU5cJaLv8el4qI52D-XiPoFjGv8VCKkSY2gUCxFsn5HMQrIJtpgrintnIR8pQY=w669-h438-no)

일단 프로그램을 실행시키면 그림 창이뜨고 확인을 누르거나 가만히 기다리면 혼자 종료한다.
일단 Exit가 들어가는 함수들과 문제가 몇 밀리세컨드 후에 종료 되는지 물었기에 sleep 함수를 확인했다. ExitWindowsEx는 윈도우 종료관련 API라서 무시했다.

![19-4](https://lh3.googleusercontent.com/FgYDWQpdudccVnWFfIH0yQtGQMf5h09CtPKPBT61VPd2ZfUg5ouK9RoCbtpIm6PElI5pNtXS5fDmhN3HdeFpsIoasziiOvbZ3IXnkLuAC422--NT5fdQQ01CNv-u6LimZlSL6WB3g4CvfuSFOKXcDv3J9enjn8gN8aYpAvxxbdEGijfo5DmTnDDEYLgddPkRSHcrRwJNERTWFHKtA3oAwkAjT6iBg6YGthG8an38SP7NoPgdCpg8-gLFKhyN2ncO7G0aGFHf2ZPmXJfyE6XCkvievnLwcpr-0ufq7hC-XqsdOfV-ab8xa230Joasp_Qi3gf8wYs9QB-qKTtnNFU4gYxbwU4LKkk-S4gANlG9Ww9Zj-KbxnFYYWAA5GE-HEsio2uDY-GQQLyUS-CM72GyND3KjChtZOOQbb7uQiyT9skDAOZ88JoeruJzdE6yA2LYyZb1dTlCMSV4mdI8vHyUTRyP6BJ5zEDQXK5TZslxrfy5rr5f-0fC1XKi_NNnDN4u945Ys6GNtCiC5FQO-jMBlMwJBVzjQoXHuplfpExN7dY4RU1GltWZ_YomtGFOWn7pRdm6GBKRYN9OFgcMzLTY0Zs1gRUDR4HzTRmmMsx1Q1BWF0k=w228-h103-no)

![19-5](https://lh3.googleusercontent.com/ZgZUSZAzCyPn2EfndKqPP2mqs1qa-Z8bHdAn6ACXZRp4BMt57fl6SLwsgQuIvMIRyWqiMXncw-N7KpgKbFdBM-yRBgf0uf80hI6kuwRqKBNyhHmeEjdKWVWWoAqr1FmSpMvYy6oTCtWOfn961h1auEuOIG7LKk-OEpBtlhg3zYIW4nPbgoes2VC-hoXzUlQW6DS1B256ImCxi0LohQ-e9LKDcYaM150NQPoQi4-_U-fqPqEW-kTZbmN7A6peqBAfJQSzuPmHt2P_l1JceaxwFkGkEU7-7Rf24rtFd3c1uGgcG5pwfUfNUSY_boxB_f0emwWmJQWOTlApmNlichDpBOxzRLCp3uaFgGzeV57tQhMgrGbO4wtYxWFNYNGy_auheIqrLNSo3NN85j6RQgvaF1JDlN2leLSCZLzDL-DlVWpJ0lJe5c2bEkbxB64A21kiTfp4JAxWd6pq9Zi_pr5o5w4SDx3TsvZTSXdp9qWIX76aNvODwycytBdeZHmqGsJTvAQKDBU0TC4V4XXdqiTW_aD1lEUYhN1IWfvBAA-Z9CBh69cDTbf-nAFIB0N97yEcdglSxdQU7V-yjnqojCVEH1__hhT9eldm4gxOSPNGktrSqqI=w480-h56-no)

일단 Exitprocess 함수 부분을 찾아서 브레이크포인트를 걸고 실행해봤더니,그림 25 같은 에러창이 떠서 안티디버깅 API가 있는지 확인했다.

![19-6](https://lh3.googleusercontent.com/gUkiqd85vA3Tj--QXkV0NEn65cfrv9s97DCUF1GIRsaF7B-G7sN0yiA3Mw5KjPnAI2IrjDBwedpmjhN0oM42KOzqYmWT_sYlrspVy29JSFgFDVob54l16iNGBHS7EZhQWOEBDDs649vmBctH3CTUZ2V_5wMsQNhBLE-rN2j3uiG6RUdpA348oj5jPgR7M02fCZKUjIIonB7Nelt3g7NWmylPVz_EOwI6XpEzwXFZ-X3pEpZWopLi10aOB4Seq0Qr-v0lklR24LzbhjTLBrIcaojn1noxD_j5eM-ckxVcKeq9Oiw4ldRvGZ1oxjwEq8XuceHNoDWZv7heVxOdcj-FNEpq3S5Y-E6l3Lx2OfA6M68PqRR8wv5ydXkgfQO5s24uaqgZspHKbsrMHQngGxw3QI8_K20RnWtqEridgsus3f2xmKC0I5codyCXREQJ_Riu61K4zW-yiXn-REHZ3w-RbOCPQrfkPOCcEAwL_5Sa6LYvx5bFLoy816xoRpkGiJMEC2ydvMM0IWY8a8AcIOjyr3c2vzYvQDd97j-yXwuCiAV8CUh4VQqhkNAWnMPt4-OJqdnvUUeMq_Zkt1begvcdLbtW9bTNuK7apscCEWzfXsY6i70=w659-h121-no)

함수목록에서 IsDebuggerPresent 를 확인했고 해당부분에 브레이크 포인트를 걸고 실행했다.
그리고 0040E969에서 에러 메시지박스 호출하는 함수로 가는 분기점에 TEST EAX,EAX를
CMP EAX,EAX 로 수정해서 Z플레그가 1이되게 저장했다.

![19-7](https://lh3.googleusercontent.com/5Sos__pg5xSrsVBroj0FK0VichA-mh2dbrQMiMR8LvUtM1aXqvyPzC0OBI_D7EqZGNrQyN_DS1okaPiyVe7LUUowsWjONbMAyz8g1QJlS6bJOGmmhu6kshY9SpvSXPb8SWKA6WRl6vDq0SX4OENtLggr2NV4VWXHY9jsyZ-nCniooUeV2aG4UT8HNZAXy_Xw-Ae_Jcq81m1a76i-rPtqZI9OL2z5koseE-uFZ1mRULbRQCwzX_mSVD6u5cjx4LMvC4efm_3Rd29Kb7PfjHGSgJcs0Gb0b0gC_bjCtb2EHjEbjbH2mc5tmmr1MjkVYu-5RXeZMRqjkXDFskf6ZRbWZNbuL5HFuRBDn3pBfVmeWSjivkyrOvF_FXYsFVkw7vvzVRpuL8VcaBsVLVr2kUIK_2Cf3ZmPb0BzAJ-JXuUJgxVumiaW4zCCsT9tZ8SIyfjWnqwSOwtK_bWAVD-qUuIJRGEU8_E_HFRp3d8czE9C0NjM8jI1bFV70yP8elNGPXH8LY6-ulpwzRp7J4O9XLeNcYhVzR2_AumS9cD_5QOGbgo58eiHL7DI0ExMWJSSy6hHvRu55L8Yw9aN-MeTXr31ZA7dJG41zh_OmWWUjlZog68QerI=w733-h79-no)

그리고 다시 실행해보니 Exitprocess는 메시지창이 출력된 후에 확인을 누른후 종료하는 루틴으로 판단되고 sleep도 전부 브레이크포인트를 걸어봤지만, 별다른게 없어서 timeGetTime에 전부 브레이크포인트를 걸어봤다. 그후 실행시키고 브레이크포인트부터 진행하면 2번반복후 0041621E에서 계속 멈추고 재 시작하는 순간 메시지박스가 생기고 사라진다. 반복문 안에서 진행 시간이 어딘가 기록된다 판단하고 그 부분을 찾아봤다.

![19-8](https://lh3.googleusercontent.com/nWJkBl5yonX-75n2EklDytorNizWERq0qBsrDbUbakElNIq1pafgZaasXq0hFf9m52niGqtd1qx6sJEjLGzZ28D9f_7xar3WeTN7H8ofixvRkTkqi9M6HXLrGOZaue9XZJh9Mg1r9SWGQKG72_loat_h4eYyG3EfvH1xb--RPFDnrZy3tVlDsUYzSMQC5I5k0piSwIEJf98ZSTemAIkKvA_-ji9n1ae2-clyBLBLRfRmX0EzWU_X-bEkAvgyNKlQDGUKIkmzZ7ph0CI23CnlmDAcjqu-UpYzhXFivPTY_YFvM8e0rXWv2rEPvPNj7iJ4lf8QXYvhFWceQAEG9R_vAtPGOMfs1As7kkyc0htr9f4dR1STFKfMrPBb5mDF8fwx0OL07AKZOtrfRrMb5a8uPyUTWzbuSBvpgHC_VeNhpin7ik1wtHlc-26A-jxqMe6yMaVh_BmnwLfKQvxk_ZrNzrEGHg8v1I7a1XgzZZDQtj_FmPcXZEn53oIVXtbnCP_WaIKgzAn0qlJDBaXGX5eKlJ69-S1tWbxo1vmi5JoRtow_rfBuWR0o5uu1NW6quqxccwIVrz7niuUJ3SMy1Oj_sjzhU6JlwMKZj0kVnHSKEziXWrk=w451-h18-no)

반복문이 두 번 실행하는데 그림 27을 보면 00444D3A에서 BTX+4값은 2B70 으로 고정되고 EAX값은 실행시키고 00444D3A까지 내려오는 시간이 기록된다. 그리고 진행하면 99444D4E에서 다시 위로 점프하고 두번째는 00444D3D에서 점프를 실행한 뒤 00444D54에서 끝나는 루틴으로 진행한다.

![19-9](https://lh3.googleusercontent.com/bqYr3Fuz4SZpRUrk3gsFXj94z2CXszANpbN5_CZ_eiIUVlTDb1Vp-edrWNWMgDhriMz5NNoBotKmpbKEeNVgEFGmn6Ptj6CgyICsY3PuXLWD7Y3XxbB816jjzaYJH_KbRUi1x610pW6mxsx0-QyQqQdhWgwkBLF1Zv7oRYxBsVg34eiDLYxLA0I4JRs1dFpYFaculFwc26ZIKoLDPDdvZt2N6gEZcdhvVkLYoosRcwAUvT2AjL4LfmfG9nymwMKzEalSe-m_3BrYZq2dnTkjB-inAx2f2Ux6gwOgMFPAtXOtbs0M1bM30NP7SbUlX-NsvvFNj2pQwCt1TvX7Y34vVleQFQSZN2rsJSjQuGRCL-eOlafsqga45Xl_xDBLdpX99SlK73Wa10ffEDDgK_1ieu8JOL0ZmGE7zQh77Por-AXC_Ce6hXt_BSbDCNMc6_f3pjJlmCJOdTVQQwnmCmxPvly1VItq9BCrNpC0Q3OEBL_XgsAJO4-7wc2xCTivs-5PUhr0gc2rJHur0h2MgmkXcbfJiffAVttwkcKNp2rrGbUvobd5zedqU2Nu1a54C3k9p069MFQYe_5pthVYMdrvD4LJWbdbQnWii1bDB5JlsaedaSI=w551-h213-no)

실행 하는 동안의 시간 값인 EAX가 EBX+4와 비교되는 것을 봤을 때 해당 값을 정답이라 판단했다. 2B70을 10진수로 바꾸면 11120 코드엔진에 확인한결과 정답이다.

![19-10](https://lh3.googleusercontent.com/H8LOfg1iOVpPrAnNN9LBp6j301T34l2twnZZI7y3EsZL1yzuWlsdJKz4wigniAhctcnXOq0S0l8FRPy_148fegP4c6LbU1HIjBVuKXUbiBKAMnbQLpGQpxOGFOSH1ZQHthBZFV0HbKpscHNXs7_iLDPgAL46Ac37mwT9eExdXXGpPpwd8ibcve1-zuBRLYQEdh3KKvHWifFuBV1XsRO5Q1dEZcp9BjRLjMMHHLGuxsEb3-D7wpLSUQIXQiInwcioZ_vA03dfhP4rR28lQ3cUR3SE406idIYObO5Jy8DYL1D4eCJkMFswR4LTqE5eYfucC0Y_lHkEaJEOGmetewCW1B39b2DlLmq68PAJ02pxHpRg0iqqRku-Cil9Lv-oTjiUx5gQyYQAMN9IuEH7elw1VR_xVBVn9EhUUWZtmavImWuEXrUEu98MwMkBvRvQQCVvj06tvi9Ig1JNDZr8iiDX_PYC9ZEgrx_-A0l1iMNmf3fRthcx0L25Ai8rpnRfcY1Lylc7v91LxVEZEbdoytH9Y0yMcEOoqanT1Ytfkb9Ymz8eni0teIP4_fF8oFpc1pZPQEQYfNKiJCLwQDzlNKNKfPLIJpeY203r53lZ4I-HKuL8eTY=w285-h105-no)
